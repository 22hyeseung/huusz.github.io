<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd"><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=yes"><title>테스트 하지 않던 코드 테스트 하기 | huusz</title><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/nayo.min.css"></head><body><header class="header"><nav class="header-nav"><span class="iconfont icon-menu mobile-toggle"></span><div class="header-menu"><a class="header-menu-link" id="header-menu-home" href="/">Home</a> <a class="header-menu-link" id="header-menu-archives" href="/archives">Archives</a> <a class="header-menu-link" id="header-menu-tags" href="/tags">Tags</a> <a class="header-menu-link" id="header-menu-about" href="/about">About</a> <a class="iconfont icon-menu-search header-menu-link" id="header-menu-search"></a></div></nav></header><div class="container"><section class="main"><article class="post"><div class="post-header"><p class="post-title">테스트 하지 않던 코드 테스트 하기</p><div class="meta-info"><span>Jul 02, 2018 </span><i class="iconfont icon-words"></i> <span>14891 letters</span></div></div><div class="post-content slideDownMin"><h1 id="도입"><a href="#도입" class="headerlink" title="도입"></a>도입</h1><p>내가 테스트를 작성하기 시작한 것은 약 2달 전이다. 그 전까지는 테스트 코드를 작성하지 않았다. 해본 적이 없었고, 어떻게 시작하는 지 몰라서였다. 구글에 검색해서 나오는 글들은 대부분 간단하고 부작용(side effect)이 없는 순수 함수들을 예제로 하고 있어서, 그렇지 않은 코드가 더 많은 실무 코드에 활용하기가 쉽지 않았다. 이 글에서는 내가 실제로 *테스트 없이 작성되어 있는 기존 코드에 어떻게 테스트를 추가하고, 동시에 TDD를 했는 지 이야기 하려고 한다. 참고로 예제 코드는 React로 작성되었고, 테스트 프레임 워크로는 Jest를 사용하였다.</p><p><sup>*테스트: 이 글에서 말하는 테스트는 단위 테스트(unit test)이다.</sup></p><p><br></p><h2 id="1-함수로-분리하자"><a href="#1-함수로-분리하자" class="headerlink" title="1. 함수로 분리하자."></a>1. 함수로 분리하자.</h2><p>프로젝트의 전반적인 컴포넌트 구조는</p><ul><li><p>[부모] Redux와 API 요청 및 React 라이프 사이클 함수를 호출하는 Container 컴포넌트</p></li><li><p>[자식] 실제 View를 반환하는 순수 함수로 작성된 Presentational 컴포넌트</p></li></ul><p>이렇게 두 컴포넌트가 중심이 된다.</p><p>사이드 이펙트가 발생할 수 있는 모든 요소는 Container 컴포넌트에 있고, Presentational 컴포넌트는 최대한 순수하게 유지하고 있다. 그렇게 하다보니, Container 컴포넌트가 정말 길고 복잡하고, 가독성도 매우 떨어졌다. 내가 테스트를 위해 가장 먼저 한 일은 Container 컴포넌트에 숨어 있는 비즈니스 로직을 순수 함수로 추출하는 일이다. 비즈니스 로직은 DOM 조작이 필요하지 않기 때문에 순수 함수로 분리해낸다면 비교적 쉽게 테스트 할 수 있다.</p><p>아래는 앞으로 글 전반에서 사용하는 예제의 풀 버전이다. 안 보고 넘어가도 글의 흐름을 이해하는 데 문제는 없다. 예제 코드는 실제 코드의 복잡도를 재현하고 싶어서 최대한 작성해 보았지만 100% 동작하는 코드는 아니다. API 요청은 fake 함수로 대체하였다.</p><h3 id="1-탐색"><a href="#1-탐색" class="headerlink" title="1) 탐색"></a>1) 탐색</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegistrationFormContainer.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="comment">// (이하 생략)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegistrationFormContainer</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  handleCloseModal = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    UserActions.closeModal();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleSubmit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">this</span>.form.validateFields(<span class="keyword">async</span> (err, validValues) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ************* 함수로 추출할 부분은 바로 여기 이다!! *****************</span></span><br><span class="line">      <span class="keyword">const</span> phone = validValues.phone</span><br><span class="line">        ? <span class="string">'+82'</span> + validValues.phone.slice(<span class="number">1</span>)</span><br><span class="line">        : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> command = &#123;</span><br><span class="line">        username: validValues.username || validValues.email,</span><br><span class="line">        email: validValues.email,</span><br><span class="line">        password: validValues.password,</span><br><span class="line">        phone: phone || <span class="literal">null</span>,</span><br><span class="line">        agreement: validValues.agreement,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// ************************************************************</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> UserActions.postRegistration(command); <span class="comment">// API 요청</span></span><br><span class="line">        <span class="keyword">this</span>.handleCloseModal(); <span class="comment">// 요청이 성공하면 모달을 닫는다.</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        Modal.error(&#123; <span class="comment">// 요청이 실패하면 에러 모달을 트리거한다.</span></span><br><span class="line">          message: <span class="string">'Register failed.'</span>,</span><br><span class="line">          icon: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> ( <span class="comment">/* UI */</span> );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(<span class="function">(<span class="params">&#123; user &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  modalVisible: user.getIn([<span class="string">'modal'</span>, <span class="string">'visible'</span>]),</span><br><span class="line">&#125;))(RegistrationFormContainer);</span><br></pre></td></tr></table></figure><h2 id="2-분리"><a href="#2-분리" class="headerlink" title="2) 분리"></a>2) 분리</h2><p>processRegistrationCommand 라는 이름의 함수를 외부 파일로 생성하고, 일단 발견한 부분을 무작정 추출해온다. 당연히 코드는 정상적으로 돌아가지 않을 것이다. 아무것도 수정하지 않는다. 다만, 어떤 것을 리턴할 것인지만 정한다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// processRegistrationCommand.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> phone = validValues.phone ? <span class="string">'+82'</span> + validValues.phone.slice(<span class="number">1</span>) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> command = &#123;</span><br><span class="line">    username: validValues.username || validValues.email,</span><br><span class="line">    email: validValues.email,</span><br><span class="line">    password: validValues.password,</span><br><span class="line">    phone: phone || <span class="literal">null</span>,</span><br><span class="line">    agreement: validValues.agreement,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> command;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아까의 RegistrationFormContainer 컴포넌트에서 새로 만든 함수를 불러와서 적용한다.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegistrationFormContainer.js</span></span><br><span class="line"><span class="keyword">import</span> processRegistrationCommand <span class="keyword">from</span> <span class="string">'../business/processRegistrationCommand'</span>;</span><br><span class="line"><span class="comment">// (생략)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegistrationFormContainer</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// (생략)</span></span><br><span class="line">   handleSubmit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">this</span>.form.validateFields(<span class="keyword">async</span> (err, validValues) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ***************************** 함수 적용 **********************</span></span><br><span class="line">      <span class="keyword">const</span> command = processRegistrationCommand();</span><br><span class="line">      <span class="comment">// ************************************************************</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> UserActions.postRegistration(command); <span class="comment">// API request</span></span><br><span class="line">        <span class="keyword">this</span>.handleCloseModal();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        Modal.error(&#123;</span><br><span class="line">          message: <span class="string">'Register failed.'</span>,</span><br><span class="line">          icon: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// (생략)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><h2 id="2-함수-스펙을-작성한다"><a href="#2-함수-스펙을-작성한다" class="headerlink" title="2. 함수 스펙을 작성한다."></a>2. 함수 스펙을 작성한다.</h2><p>이제 테스트 파일을 만든다. 그리고 아까 추출한 processRegistrationCommand 함수를 불러온다. 그리고 describe, test 구문을 이용해 스펙을 작성한다. 처음부터 모든 시나리오를 빠짐없이 적으려 할 필요는 없다. 천천히 하나씩 스펙을 추가해도 상관없다. 시작은 주로 핵심 기능으로 시작하는 데, 이는 대부분 Input, Output에 드러나있다. 아래는 테스트는 핵심 기능에 대한 스펙들이 미리 추가된 것이다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// processRegistrationCommand.test.js</span></span><br><span class="line"><span class="keyword">import</span> processRegistrationCommand <span class="keyword">from</span> <span class="string">'./processRegistrationCommand'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'processRegistrationCommand 함수는'</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">'오류를 던지지 않는다.'</span>, () =&gt; &#123;</span><br><span class="line">    expect(processRegistrationCommand).not.toThrowError();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'Registration 요청 커맨드 객체 형태로 정제하여 반환하는 데, '</span>, () =&gt; &#123;</span><br><span class="line">    test(<span class="string">'username 속성의 default 값은 email이다.'</span>);</span><br><span class="line">    test(<span class="string">'email 속성은 입력 값과 동일하다.'</span>);</span><br><span class="line">    test(<span class="string">'email 속성은 입력 값과 동일하다.'</span>);</span><br><span class="line">    test(<span class="string">'phone 속성은 옵션 값이며, default 값은 null이다.'</span>);</span><br><span class="line">    test(<span class="string">'phone 속성은 첫 번째 0 대신 +82가 포함된 문자열이다.'</span>);</span><br><span class="line">    test(<span class="string">'agreement 속성은 입력 값과 동일하다.'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><br></p><h2 id="3-테스트-코드를-작성해보자"><a href="#3-테스트-코드를-작성해보자" class="headerlink" title="3. 테스트 코드를 작성해보자!"></a>3. 테스트 코드를 작성해보자!</h2><h3 id="1-실패하는-테스트"><a href="#1-실패하는-테스트" class="headerlink" title="1) 실패하는 테스트"></a>1) 실패하는 테스트</h3><p>현재 첫 번째 테스트는 실패하고 있다. processRegistrationCommand 함수가 현재 오류를 던지고 있기 때문이다. 테스트가 통과하도록 프로덕션 코드를 수정해준다. validValues 변수가 해당 함수의 스코프 내에서 정의되지 않아 오류가 발생한 것이기 때문에, 해당 변수를 파라미터로 받게 하여 오류를 제거한다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">validValues = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> phone = validValues.phone ? <span class="string">'+82'</span> + validValues.phone.slice(<span class="number">1</span>) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> command = &#123;</span><br><span class="line">    username: validValues.username || validValues.email,</span><br><span class="line">    email: validValues.email,</span><br><span class="line">    password: validValues.password,</span><br><span class="line">    phone: phone || <span class="literal">null</span>,</span><br><span class="line">    agreement: validValues.agreement,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> command;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><h3 id="2-성공하는-테스트"><a href="#2-성공하는-테스트" class="headerlink" title="2) 성공하는 테스트"></a>2) 성공하는 테스트</h3><p>나머지 테스트 코드를 하나씩 채워볼 것이다. 두번째 테스트는 실패하지 않을 것이다. 이미 모두 구현되어 있기 때문이다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> processRegistrationCommand <span class="keyword">from</span> <span class="string">'./processRegistrationCommand'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'processRegistrationCommand 함수는'</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">'오류를 던지지 않는다.'</span>, () =&gt; &#123;</span><br><span class="line">    expect(processRegistrationCommand).not.toThrowError();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'Registration 요청 커맨드 객체 형태로 정제하여 반환하는 데, '</span>, () =&gt; &#123;</span><br><span class="line">    test(<span class="string">'username 속성의 default 값은 email이다.'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> param = &#123;</span><br><span class="line">        username: <span class="literal">undefined</span>,</span><br><span class="line">        email: <span class="string">'user@email.com'</span>,</span><br><span class="line">        password: <span class="string">'password'</span>,</span><br><span class="line">        phone: <span class="string">'01040022068'</span>,</span><br><span class="line">        agreement: [<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>],</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">      expect(actual.username).toBe(param.email);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>세번째, 네번째 테스트도 추가한다. 물론 성공하는 테스트이다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'email 속성은 입력 값과 동일하다.'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> param = &#123;</span><br><span class="line">    username: <span class="string">'username'</span>,</span><br><span class="line">    email: <span class="string">'user@email.com'</span>,</span><br><span class="line">    password: <span class="string">'password'</span>,</span><br><span class="line">    phone: <span class="string">'01040022068'</span>,</span><br><span class="line">    agreement: [<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">  expect(actual.email).toBe(param.email);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'password 속성은 입력 값과 동일하다.'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> param = &#123;</span><br><span class="line">    username: <span class="string">'username'</span>,</span><br><span class="line">    email: <span class="string">'user@email.com'</span>,</span><br><span class="line">    password: <span class="string">'password'</span>,</span><br><span class="line">    phone: <span class="string">'01040022068'</span>,</span><br><span class="line">    agreement: [<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">  expect(actual.password).toBe(param.password);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>이쯤하면 약간 거슬리는 부분이 생긴다. 바로, 동일한 param 객체를 반복해서 생성하고 있는 부분이다. param 객체와 같이 테스트를 위해 생성되는 데이터를 <strong>Fixture</strong> 라고 한다. 위와 같이 여러 테스트에서 반복적으로 사용되는 Fixture는 좀 더 상위 스코프에 선언하는 편이 낫다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'processRegistrationCommand 함수는'</span>, () =&gt; &#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line">  describe(<span class="string">'Registration 요청 커맨드 객체 형태로 정제하여 반환하는 데, '</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> param = &#123;</span><br><span class="line">      username: <span class="string">'username'</span>,</span><br><span class="line">      email: <span class="string">'user@email.com'</span>,</span><br><span class="line">      password: <span class="string">'password'</span>,</span><br><span class="line">      phone: <span class="string">'01040022068'</span>,</span><br><span class="line">      agreement: [<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    test(<span class="string">'username 속성의 default 값은 email이다.'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> actual = processRegistrationCommand(&#123;</span><br><span class="line">        ...param,</span><br><span class="line">        username: <span class="literal">undefined</span>,</span><br><span class="line">      &#125;); <span class="comment">// &lt;- 테스트가 검증하고자 하는 바가 username이 undefined 일 때 임이 한눈에 보인다.</span></span><br><span class="line">      expect(actual.username).toBe(param.email);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    test(<span class="string">'email 속성은 입력 값과 동일하다.'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">      expect(actual.email).toBe(param.email);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    test(<span class="string">'password 속성은 입력 값과 동일하다.'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">      expect(actual.password).toBe(param.password);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    test(<span class="string">'phone 속성은 옵션 값이며, default 값은 null이다.'</span>);</span><br><span class="line">    test(<span class="string">'phone 속성은 첫 번째 0 대신 +82가 포함된 문자열이다.'</span>);</span><br><span class="line">    test(<span class="string">'agreement 속성은 입력 값과 동일하다.'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>이렇게 Fixture를 상위 스코프에 선언해주면, 동일한 또는 유사한 Fixture를 반복적으로 생성하지 않아도 되기 때문에 코드가 훨씬 간결해질 뿐 아니라, 테스트에서 검증하고자 하는 특정 값이 더 명확하게 보여 테스트의 가독성을 높이는 효과를 얻을 수 있다.</p><p>이제 나머지 테스트도 채워보자. 이번에도 모두 성공하는 테스트이다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'phone 속성은 옵션 값이며, default 값은 null이다.'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> actual = processRegistrationCommand(&#123; ...param, <span class="attr">phone</span>: <span class="literal">undefined</span> &#125;);</span><br><span class="line">  expect(actual.phone).toBeNull();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'phone 속성은 첫 번째 0 대신 +82가 포함된 문자열이다.'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">  expect(actual.phone).toBe(<span class="string">`+82<span class="subst">$&#123;param.phone.slice(<span class="number">1</span>)&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'agreement 속성은 입력 값과 동일하다.'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">  expect(actual.agreement).toBe(param.agreement);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>전체적으로 한번 쭉 보니, 대부분의 테스트가 동일한 패턴으로 반복되고 있다. 동일하게 반복되는 이러한 패턴에 맘에 들지 않는다면, 이것도 간략하게 정리할 수 있다. 아래는 정리하고 난 후의 전체 코드이다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> processRegistrationCommand <span class="keyword">from</span> <span class="string">'./processRegistrationCommand'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'processRegistrationCommand 함수는'</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">'오류를 던지지 않는다.'</span>, () =&gt; &#123;</span><br><span class="line">    expect(processRegistrationCommand).not.toThrowError();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'Registration 요청 커맨드 객체 형태로 정제하여 반환하는 데, '</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> param = &#123;</span><br><span class="line">      username: <span class="string">'username'</span>,</span><br><span class="line">      email: <span class="string">'user@email.com'</span>,</span><br><span class="line">      password: <span class="string">'password'</span>,</span><br><span class="line">      phone: <span class="string">'01040022068'</span>,</span><br><span class="line">      agreement: [<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> equalToParam = [<span class="string">'name'</span>, <span class="string">'password'</span>, <span class="string">'agreement'</span>];</span><br><span class="line">    equalToParam.forEach(<span class="function"><span class="params">prop</span> =&gt;</span> &#123;</span><br><span class="line">      test(<span class="string">`<span class="subst">$&#123;prop&#125;</span> 속성은 입력 값과 동일하다.`</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">        expect(actual[prop]).toBe(param[prop]);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> defaultOf = [</span><br><span class="line">      &#123;</span><br><span class="line">        key: <span class="string">'username'</span>,</span><br><span class="line">        expected: param.email,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        key: <span class="string">'phone'</span>,</span><br><span class="line">        expected: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ];</span><br><span class="line">    defaultOf.forEach(<span class="function">(<span class="params">&#123; key, expected &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      test(<span class="string">`<span class="subst">$&#123;key&#125;</span> 속성은 옵션 값이며, default 값은 <span class="subst">$&#123;expected&#125;</span>이다.`</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> actual = processRegistrationCommand(&#123;</span><br><span class="line">          ...param,</span><br><span class="line">          [key]: <span class="literal">undefined</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        expect(actual[key]).toBe(expected);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    test(<span class="string">'phone 속성은 첫 번째 0 대신 +82가 포함된 문자열이다.'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> actual = processRegistrationCommand(param);</span><br><span class="line">      expect(actual.phone).toBe(<span class="string">`+82<span class="subst">$&#123;param.phone.slice(<span class="number">1</span>)&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>이런 식으로 반복되는 테스트 코드의 패턴을 파악해서 코드의 양을 줄일 수 있을 뿐 아니라, equalToParam이나 defaultOf 같은 Fixture만 보고도 대략적인 내용을 파악할 수 있게 되어 가독성 면에서도 더 나아진다. 하지만 이 가독성이라는 게 다소 상대적인 것이라, 이전의 나열 방식이 더 낫다고 생각할 수도 있다. 그리고 이처럼 Fixture와 반복문을 이용해 중복을 제거하는 방식이 <strong>항상</strong> 가독성이 더 좋은 것도 아니다. 상황에 따라, 선호도에 따라, 적절히 잘 선택하면 된다.</p><p><br></p><h3 id="3-Refactor-테스트가-실패하지-않는-범위-내에서-코드-개선하기"><a href="#3-Refactor-테스트가-실패하지-않는-범위-내에서-코드-개선하기" class="headerlink" title="3) Refactor - 테스트가 실패하지 않는 범위 내에서 코드 개선하기"></a>3) Refactor - 테스트가 실패하지 않는 범위 내에서 코드 개선하기</h3><p>테스트를 마쳤고 모든 테스트가 성공하는 것을 확인했으니 이제 리팩터링을 할 수 있다. 리팩터링 단계에서 중요한 것은, 테스트가 실패하지 않는 범위 내에서만 코드를 개선하는 것이다. 이 말은, 리팩터링 하다가 테스트가 실패하면 테스트를 고치라는 것이 아니다. 리팩터링을 하는 중에는 절대 테스트에 아무런 변화도 가해선 안 된다. 리팩터링을 하다가 테스트가 실패한다면, 분명 프로덕션 코드에 버그를 만든 것이니 하던 것을 중단하고 코드를 다시 되돌려 놓아야 한다. 아래는 현재 프로덕션 코드이다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// processRegistrationCommand.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">validValues = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> phone = validValues.phone ? <span class="string">'+82'</span> + validValues.phone.slice(<span class="number">1</span>) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> command = &#123;</span><br><span class="line">    username: validValues.username || validValues.email,</span><br><span class="line">    email: validValues.email,</span><br><span class="line">    password: validValues.password,</span><br><span class="line">    phone: phone || <span class="literal">null</span>,</span><br><span class="line">    agreement: validValues.agreement,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> command;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>먼저, validValues 라는 파라미터 명이 좀 별로인 것 같다. validValues인지 아닌지는 이 함수는 몰라도 된다. 그냥 source로 바꿔준다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> phone = source.phone ? <span class="string">'+82'</span> + source.phone.slice(<span class="number">1</span>) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> command = &#123;</span><br><span class="line">    username: source.username || source.email,</span><br><span class="line">    email: source.email,</span><br><span class="line">    password: source.password,</span><br><span class="line">    phone: phone || <span class="literal">null</span>,</span><br><span class="line">    agreement: source.agreement,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> command;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그 다음, 어차피 리턴해 줄 command 객체를 굳이 변수 선언 해주는 것도 별로인 것 같다. 변수로 선언하지 않고, 곧장 리턴해준다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> phone = source.phone ? <span class="string">'+82'</span> + source.phone.slice(<span class="number">1</span>) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    username: source.username || source.email,</span><br><span class="line">    email: source.email,</span><br><span class="line">    password: source.password,</span><br><span class="line">    phone: phone || <span class="literal">null</span>,</span><br><span class="line">    agreement: source.agreement,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>source.</code>이 계속 반복 되는 것도 좀 별로다. 없애면 커맨드 객체 부분이 더 깔끔해질 것 같다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, email, password, phone, agreement &#125; = source;</span><br><span class="line">  <span class="comment">// phone 변수 명이 중복되어 formattedPhone로 변경해주었다.</span></span><br><span class="line">  <span class="keyword">const</span> formattedPhone = phone ? <span class="string">'+82'</span> + phone.slice(<span class="number">1</span>) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    username: username || email,</span><br><span class="line">    email: email,</span><br><span class="line">    password: password,</span><br><span class="line">    phone: formattedPhone || <span class="literal">null</span>,</span><br><span class="line">    agreement: agreement,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>formattedPhone도 굳이 변수 선언해주지 않고 바로 적용해도 괜찮을 것 같다. 게다가 <code>:null</code>과 <code>||null</code> 부분 동일한 로직이 두 번 들어가 있다. 하나는 없애도 무방하다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, email, password, phone, agreement &#125; = source;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    username: username || email,</span><br><span class="line">    email: email,</span><br><span class="line">    password: password,</span><br><span class="line">    phone: phone ? <span class="string">'+82'</span> + phone.slice(<span class="number">1</span>) : <span class="literal">null</span>,</span><br><span class="line">    agreement: agreement,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>phone 속성의 <code>&#39;+82&#39; + phone.slice(1)</code> 를 템플릿 리터럴(<a href="https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Template_literals" target="_blank" rel="noopener">Template literals</a>)로 변경해줄 수도 있다. (이 부분은 개인적인 취향이므로 해도 그만, 안 해도 그만이다.)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, email, password, phone, agreement &#125; = source;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    username: username || email,</span><br><span class="line">    email: email,</span><br><span class="line">    password: password,</span><br><span class="line">    phone: phone ? <span class="string">`+82<span class="subst">$&#123;phone.slice(<span class="number">1</span>)&#125;</span>`</span> : <span class="literal">null</span>,</span><br><span class="line">    agreement: agreement,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>리팩터링이 끝났다. 코드가 처음보다 훨씬 깔끔하고 간결해졌다! 사실 첫 코드 자체가 그리 복잡하지도 지저분하지도 않았어서, 여지껏 테스트하고, 리팩터링하고 하며 들인 노력에 비해 크게 개선된 것 같지 않아 보일 수도 있겠다. 하지만 우리의 프로덕션 코드에 항상 이런 간략하고 복잡하지 않은 코드만 있는 것은 아니니까.. 분명 이렇게 테스트와 리팩터링을 반복하다보면 코드가 점점 직관적이게, 그리고 깔끔하게 변하는 것을 경험 하게 된다.</p><p><br></p><h2 id="4-스펙을-추가하자-여기부터-TDD이다"><a href="#4-스펙을-추가하자-여기부터-TDD이다" class="headerlink" title="++ 4. 스펙을 추가하자! (여기부터 TDD이다)"></a>++ 4. 스펙을 추가하자! (여기부터 TDD이다)</h2><p>새로운 비즈니스 요구 사항은 언제나 들어올 수 있다. 새로운 요구사항은 곧 새로운 기능이고, 기존에 없던 새로운 코드가 만들어져야 하는 순간이다. 이 때가 바로 TDD를 할 수 있는 황금 같은 기회이다. 아래와 같은 요구사항이 추가되었다고 가정해보자.</p><p><br></p><h4 id="유저로부터-국가-정보를-입력-받는다-중국이면-86을-한국이면-82를-적용한다"><a href="#유저로부터-국가-정보를-입력-받는다-중국이면-86을-한국이면-82를-적용한다" class="headerlink" title="유저로부터 국가 정보를 입력 받는다. 중국이면 +86을, 한국이면 +82를 적용한다."></a><strong><em>유저로부터 국가 정보를 입력 받는다. 중국이면 +86을, 한국이면 +82를 적용한다.</em></strong></h4><p><br></p><h3 id="1-먼저-테스트-코드부터-작성한다-RED"><a href="#1-먼저-테스트-코드부터-작성한다-RED" class="headerlink" title="1. 먼저 테스트 코드부터 작성한다. (RED)"></a>1. 먼저 테스트 코드부터 작성한다. (RED)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> <span class="keyword">const</span> param = &#123;</span><br><span class="line">   username: <span class="string">'username'</span>,</span><br><span class="line">   email: <span class="string">'user@email.com'</span>,</span><br><span class="line">   password: <span class="string">'password'</span>,</span><br><span class="line">   phone: <span class="string">'01040022068'</span>,</span><br><span class="line">   agreement: [<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>],</span><br><span class="line">   country: <span class="string">'China'</span>, <span class="comment">// 유저로부터 입력 받는 값이 추가 되었다.</span></span><br><span class="line"> &#125;;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"> test(<span class="string">'phone 속성은 국가 정보가 중국이면, +86이 포함된 문자열이다.'</span>, () =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> actual = processRegistrationCommand(&#123; ...param, <span class="attr">country</span>: <span class="string">'China'</span> &#125;);</span><br><span class="line">   expect(actual.phone).toBe(<span class="string">`+86<span class="subst">$&#123;param.phone.slice(<span class="number">1</span>)&#125;</span>`</span>);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p>유저로부터 입력 받는 값에 국가 정보가 추가 되었으므로, param Fixture에 속성을 추가한다. 그리고 새로운 요구사항을 스펙으로 추가하였다. 테스트 먼저 작성되었고 구현코드는 존재하지 않으니 테스트는 당연히 실패한다. TDD의 첫 번째 단계, Red이다.</p><p><br></p><h3 id="2-프로덕션-코드를-수정한다-GREEN"><a href="#2-프로덕션-코드를-수정한다-GREEN" class="headerlink" title="2. 프로덕션 코드를 수정한다. (GREEN)"></a>2. 프로덕션 코드를 수정한다. (GREEN)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// processRegistrationCommand.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// source에 country 속성이 추가되었다.</span></span><br><span class="line">  <span class="keyword">const</span> &#123; username, email, password, phone, agreement, country &#125; = source;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> countryCodeAdded;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// country 속성의 값에 따라 국가 번호를 다르게 적용한다.</span></span><br><span class="line">  <span class="keyword">if</span> (!phone) &#123;</span><br><span class="line">    countryCodeAdded = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (country === <span class="string">'China'</span>) &#123;</span><br><span class="line">    countryCodeAdded = <span class="string">`+86<span class="subst">$&#123;phone.slice(<span class="number">1</span>)&#125;</span>`</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    countryCodeAdded = <span class="string">`+82<span class="subst">$&#123;phone.slice(<span class="number">1</span>)&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    username: username || email,</span><br><span class="line">    email: email,</span><br><span class="line">    password: password,</span><br><span class="line">    phone: countryCodeAdded,</span><br><span class="line">    agreement: agreement,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이렇게 프로덕션 코드를 추가해서 테스트를 성공시킨다. 이게 TDD의 두 번째, Green 단계이다. 코드가 좀 더럽더라도 참아야 한다. Green 단계에서 반드시 지켜야 하는 원칙이 하나 있는 데, <strong>테스트가 성공할 만큼만</strong> 코딩하는 것이다. 리팩터링 단계가 괜히 있는 게 아니다. 이 단계에서는 많은 생각을 하지 않고, 테스트를 성공시키는 것에만 집중한다.</p><p><br></p><h3 id="3-리팩터링-한다-REFACTOR"><a href="#3-리팩터링-한다-REFACTOR" class="headerlink" title="3. 리팩터링 한다.(REFACTOR)"></a>3. 리팩터링 한다.(REFACTOR)</h3><p>드디어 리팩터링 단계이다. 위 코드를 좀 깨끗하게 정리해보자. 먼저, else if 문을 없애고 싶다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, email, password, phone, agreement, country &#125; = source;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> countryCodes = &#123;</span><br><span class="line">    Korea: <span class="number">82</span>,</span><br><span class="line">    China: <span class="number">86</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> countryCodeAdded;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!phone) &#123;</span><br><span class="line">    countryCodeAdded = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    countryCodeAdded = <span class="string">`+<span class="subst">$&#123;countryCodes[country]&#125;</span><span class="subst">$&#123;phone.slice(<span class="number">1</span>)&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    username: username || email,</span><br><span class="line">    email: email,</span><br><span class="line">    password: password,</span><br><span class="line">    phone: countryCodeAdded,</span><br><span class="line">    agreement: agreement,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>country 속성을 통해 넘어오는 국가 명을 key로, 국가 번호를 value로 하는 객체를 생성하여 else if 문을 제거해주었다. 다음으로, if 문을 제거해준다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">processRegistrationCommand</span>(<span class="params">source = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, email, password, phone, agreement, country &#125; = source;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> countryCodes = &#123;</span><br><span class="line">    Korea: <span class="number">82</span>,</span><br><span class="line">    China: <span class="number">86</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    username: username || email,</span><br><span class="line">    email: email,</span><br><span class="line">    password: password,</span><br><span class="line">    phone: phone ? <span class="string">`+<span class="subst">$&#123;countryCodes[country]&#125;</span><span class="subst">$&#123;phone.slice(<span class="number">1</span>)&#125;</span>`</span> : <span class="literal">null</span>,</span><br><span class="line">    agreement: agreement,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>여기서 리팩터링한 phone 속성 부분은 본래 삼항연산자를 사용해 if문 없이 작성되어 있었는 데, 스펙이 추가되면서 오히려 지저분해졌었다. 이처럼 요구사항이 추가되면서 깔끔했던 코드가 오히려 퇴보하는 일은 생각보다 흔하게 발생한다. 이때 테스트가 있다면 리팩터링을 쉽고 안정적으로 할 수 있겠지만 테스트가 없다면? 혹여나 버그가 생길까 굉장히 두려움에 떨며 리팩터링을 하거나, 혹은 위험 요소를 만들지 않기 위해 아예 리팩터링을 포기해버릴 수도 있을 것이다. 포기를 선택한다면, 당연히, 요구 사항이 추가될 때 마다 코드는 끝도 없이 지저분해질 것이다. 물론 TDD를 한다면 걱정할 필요가 없다.</p><p><br></p><p>완성된 코드는 아래에서 볼 수 있다.</p><iframe src="https://codesandbox.io/embed/8xowy3l4v2?fontsize=16&module=%2Fsrc%2Fbusiness%2FprocessRegistrationCommand.test.js&previewwindow=tests&view=editor" style="width:100%;height:500px;border:0;border-radius:4px;overflow:hidden" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe><p><a href="https://codesandbox.io/s/8xowy3l4v2?fontsize=16&amp;module=%2Fsrc%2Fbusiness%2FprocessRegistrationCommand.test.js&amp;previewwindow=tests" target="_blank" rel="noopener"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit Testing-not-tested-code"></a></p><h2 id="맺음"><a href="#맺음" class="headerlink" title="맺음"></a>맺음</h2><p>이 글을 통해 말하고자 했던 바는 “TDD를 하세요!” 가 아니다. 테스트를 처음 한다면, 그리고 어디서부터 시작해야 할 지 모르겠다면, 기존에 이미 작성되어 있는 코드에 테스트를 추가하는 것부터 시작한다. 이 방법은 실제로 내가 시작했던 방식이고, 지금도 여전히 하고 있는 방법이다. 나는 아직도 테스트가 무지 어렵다. 테스트를 할 수는 있지만, 잘 하는 방법은 아직 잘 모른다. 그래도 계속 하고 있다. 뻘짓도 해보고 삽질도 해보면서, 깨달음도 얻고 더 좋은 방법을 터득해 나가는 중이다. 막막하고 모르겠다고 시작하지 않으면, 은퇴하는 그 날까지도 시작할 수 없을 지 모른다. 일단 시작부터 하자! 그리고 조급하게 생각하지 말자! 경력 30년된 우리 회사 CTO님이 테스트 케이스 만 개 정도는 작성해봐야 한다고 했다!</p></div><div class="post-meta"><i class="iconfont icon-category"></i> <a class="category-link" href="/categories/Test/">Test</a> <i class="iconfont icon-tag"></i> <a class="tag-link" href="/tags/React-test/">React test</a> <a class="tag-link" href="/tags/TDD/">TDD</a> <a class="tag-link" href="/tags/Unit-test/">Unit test</a></div><div class="post-footer"><div class="pf-left"><img class="pf-avatar" src="/images/header.png"><p class="pf-des">이혜승, Junior, Frontend Developer.</p></div><div class="pf-right"><div class="pf-links"><script id="-mob-share" src="http://f1.webshare.mob.com/code/mob-share.js?appkey=21d601593a1de"></script><span class="share-btn"><span class="iconfont icon-share"></span></span><div class="-mob-share sildeUpMin"><a class="iconfont icon-share-facebook -mob-share-facebook"></a> <a class="iconfont icon-share-google -mob-share-google"></a></div></div><nav class="pf-paginator"><a href="/2018/TIL/TIL180529-unit-test-pattern/" data-hover="Unit test style">Next</a></nav></div></div><div id="disqus_thread"></div><script>!function(){var t=document,e=t.createElement("script");e.src="https://huusz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></article></section></div><a id="backTop"><span><i class="iconfont icon-backtotop"></i></span></a><div class="search-container sildeUpMin"><div class="search-header"><input type="text" placeholder="Typing Something here." id="search-input" class="search-input"> <span class="search-cancel iconfont icon-cancel"></span></div><div id="search-result" class="search-result"></div></div><div class="mobile-menu"><img class="mobile-menu-icon" src="/images/favicon.png"> <a class="mobile-menu-link" href="/">Home </a><a class="mobile-menu-link" href="/archives">Archives </a><a class="mobile-menu-link" href="/tags">Tags </a><a class="mobile-menu-link" href="/about">About </a><a class="mobile-menu-link mobile-menu-search" href="#">Search</a></div><footer id="footer"><div class="footer-copyright">&copy; 2018 huusz<br>Theme By <a href="https://github.com/Lemonreds/hexo-theme-Nayo" target="_blank">Nayo</a></div></footer><script src="/nayo.bundle.js"></script></body></html>